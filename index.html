<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Chainsaw | WASM Data Workbench</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Monaco Editor Loader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <!-- Pyodide (Updated to v0.26.4 for better stability) -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
    <!-- WebPerl (Perl WASM) -->
    <script src="https://webperl.zero-g.net/v0.09-beta/webperl.js"></script>
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; height: 100vh; overflow: hidden; }
        #editor-container { flex: 1; border: 1px solid #334155; min-height: 300px; }
        .tab-active { border-bottom: 2px solid #38bdf8; color: #38bdf8; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        #output-area { font-family: 'Fira Code', monospace; }
        .footer-link { color: #38bdf8; text-decoration: none; border-bottom: 1px solid transparent; transition: all 0.2s; }
        .footer-link:hover { border-bottom: 1px solid #38bdf8; }

        /* Tooltip Styles */
        .tooltip-container { position: relative; display: inline-block; }
        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #1e293b;
            color: #fff;
            text-align: center;
            border: 1px solid #475569;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            top: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 10px;
            line-height: 1.4;
            pointer-events: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        
        /* Focus ring for accessibility */
        .custom-focus:focus {
            outline: 2px solid #38bdf8;
            outline-offset: 2px;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="flex flex-col">

    <!-- Header -->
    <header class="p-4 border-b border-slate-700 flex flex-wrap justify-between items-center bg-slate-900 gap-3">
        <div class="flex items-center gap-3">
            <span class="text-2xl">ü™ö</span>
            <div>
                <h1 class="text-xl font-bold tracking-tight text-white">Data Chainsaw</h1>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <a href="https://github.com/arkraieski/wasm_chainsaw" target="_blank" class="text-slate-400 hover:text-white transition-colors flex items-center gap-2 text-xs custom-focus rounded p-1">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
                <span class="hidden sm:inline">Source</span>
            </a>

            <div class="tooltip-container">
                <button id="downloadBtn" onclick="downloadData()" class="text-xs bg-slate-800 hover:bg-slate-700 px-3 py-2 rounded-lg border border-slate-600 transition-all hidden flex items-center gap-2 custom-focus">
                    üì• Download CSV
                </button>
                <span class="tooltip-text">Downloads the current state of 'uploaded_data.csv' from the WASM virtual filesystem. Use this to save your cleaned or transformed data.</span>
            </div>
            
            <label 
                id="fileInputLabel"
                for="fileInput" 
                tabindex="0" 
                role="button"
                aria-label="Upload CSV File"
                onkeydown="handleFileUploadKey(event)"
                class="cursor-pointer bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg transition-all text-sm font-semibold custom-focus block"
            >
                <span>üìÅ Upload File</span>
                <input type="file" id="fileInput" class="hidden">
            </label>
            <div id="status" class="hidden lg:block text-xs font-mono text-slate-400">Initializing Engines...</div>
        </div>
    </header>

    <!-- Main Content: Mobile Stack vs Desktop Side-by-Side -->
    <main class="flex flex-1 flex-col md:flex-row overflow-hidden">
        
        <!-- Left Panel: Editor (Takes 50% height on mobile, 50% width on desktop) -->
        <div class="h-1/2 md:h-auto md:w-1/2 flex flex-col border-b md:border-b-0 md:border-r border-slate-700 overflow-hidden">
            <!-- Language Selection -->
            <div class="flex bg-slate-900 border-b border-slate-700 text-sm">
                <button onclick="switchLang('python')" id="btn-python" class="px-4 py-2 md:px-6 md:py-3 font-medium transition-all tab-active text-xs md:text-sm custom-focus">Python</button>
                <button onclick="switchLang('perl')" id="btn-perl" class="px-4 py-2 md:px-6 md:py-3 font-medium transition-all text-xs md:text-sm custom-focus">Perl</button>
            </div>

            <!-- Recipes -->
            <div class="p-2 bg-slate-800 flex gap-2 overflow-x-auto text-[10px] md:text-xs no-scrollbar">
                <span class="text-slate-500 py-1 flex-shrink-0">Recipes:</span>
                <div id="recipes-python" class="flex gap-2">
                    <button onclick="loadRecipe('py_basic')" class="bg-slate-700 hover:bg-blue-900 px-2 py-1 rounded border border-slate-600 flex-shrink-0 custom-focus">CSV Stats</button>
                    <button onclick="loadRecipe('py_viz')" class="bg-slate-700 hover:bg-blue-900 px-2 py-1 rounded border border-slate-600 flex-shrink-0 custom-focus">Viz Chart</button>
                    <button onclick="loadRecipe('py_clean')" class="bg-slate-700 hover:bg-blue-900 px-2 py-1 rounded border border-slate-600 flex-shrink-0 custom-focus">Regex Clean</button>
                </div>
                <div id="recipes-perl" class="hidden flex gap-2">
                    <button onclick="loadRecipe('pl_grep')" class="bg-slate-700 hover:bg-amber-900 px-2 py-1 rounded border border-slate-600 flex-shrink-0 custom-focus">Grep</button>
                    <button onclick="loadRecipe('pl_transform')" class="bg-slate-700 hover:bg-amber-900 px-2 py-1 rounded border border-slate-600 flex-shrink-0 custom-focus">Transform</button>
                </div>
            </div>

            <div id="editor-container"></div>

            <div class="p-3 bg-slate-900 border-t border-slate-700 flex justify-between items-center">
                <button id="runBtn" disabled onclick="runScript()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg disabled:opacity-50 transition-all text-xs md:text-sm uppercase tracking-wider custom-focus">
                    Run Workbench
                </button>
                <div id="file-indicator" class="text-[10px] md:text-xs text-slate-500 italic truncate ml-2">No file uploaded</div>
            </div>
        </div>

        <!-- Right Panel: Output (Takes 50% height on mobile, 50% width on desktop) -->
        <div class="h-1/2 md:h-auto md:w-1/2 flex flex-col bg-slate-950 overflow-y-auto p-4 md:p-6" id="output-pane">
            <h2 class="text-[10px] md:text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Output / Visualization</h2>
            
            <div id="viz-container" class="bg-white rounded-lg hidden mb-4 overflow-hidden shadow-2xl">
                <!-- Charts render here -->
                <img id="py-chart" class="w-full h-auto" />
            </div>

            <pre id="output-area" class="text-xs md:text-sm text-green-400 whitespace-pre-wrap font-mono"></pre>
        </div>
    </main>

    <!-- Footer -->
    <footer class="p-2 bg-slate-900 border-t border-slate-800 text-center text-[10px] md:text-[11px] text-slate-500">
        Data Chainsaw &copy; 2026 | Built by <a href="https://kraieski.dev" target="_blank" class="footer-link custom-focus">kraieski.dev</a> | Powered by WASM
    </footer>

    <script>
        let editor;
        let pyodide;
        let currentLang = 'python';
        let uploadedFileData = "";

        // Accessibility handler for file upload
        function handleFileUploadKey(event) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                document.getElementById('fileInput').click();
            }
        }

        // Initial Recipes
        const recipes = {
            py_basic: `# Import necessary libraries\nimport pandas as pd\nimport io\n\ntry:\n    # Load the file stored in the WASM virtual filesystem\n    df = pd.read_csv('uploaded_data.csv')\n    \n    # Generate and print statistical summary\n    print("--- DATASET SUMMARY ---")\n    print(df.describe())\n    \n    print("\\n--- COLUMN DATA TYPES ---")\n    print(df.dtypes)\nexcept Exception as e:\n    print(f"Error: {e}. Please ensure a CSV file is uploaded.")`,
            
            py_viz: `# Import viz and data libraries\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport io, base64\n\ntry:\n    # Read data from the virtual 'uploaded_data.csv'\n    df = pd.read_csv('uploaded_data.csv')\n\n    # Create a plot using the first two numeric columns\n    plt.figure(figsize=(10, 6))\n    df.select_dtypes(include=['number']).iloc[:, 0:2].plot(kind='line')\n    \n    plt.title("WASM Data Chainsaw Output")\n    plt.xlabel("Index")\n    plt.ylabel("Values")\n    plt.grid(True, linestyle='--', alpha=0.7)\n\n    # Convert plot to Base64 to send it to the UI container\n    buf = io.BytesIO()\n    plt.savefig(buf, format='png', dpi=100)\n    buf.seek(0)\n    img_str = base64.b64encode(buf.read()).decode('utf-8')\n    \n    # Send signal to the JS layer to render the chart\n    print(f"##CHART##{img_str}")\n    print("Visualization generated successfully.")\nexcept Exception as e:\n    print(f"Visualization error: {e}")`,

            py_clean: `# Clean and export data back to the filesystem\nimport pandas as pd\n\ntry:\n    df = pd.read_csv('uploaded_data.csv')\n    \n    # 1. Drop rows that contain any missing values\n    df_clean = df.dropna()\n    \n    # 2. Reset the index for the new dataset\n    df_clean = df_clean.reset_index(drop=True)\n    \n    # 3. Save the cleaned data back to the virtual FS for download\n    df_clean.to_csv('uploaded_data.csv', index=False)\n    \n    print("Data cleaned! Rows remaining:", len(df_clean))\n    print("\\nPreview of cleaned data:")\n    print(df_clean.head())\nexcept Exception as e:\n    print(f"Cleaning error: {e}")`,

            pl_grep: `# Perl Regex Power: Find specific patterns\nuse strict;\nuse warnings;\n\nmy $file = 'uploaded_data.csv';\n\nif (-e $file) {\n    open(my $fh, '<', $file) or die "Could not open $file: $!";\n    print "--- SEARCH RESULTS ---\\n";\n    while (my $line = <$fh>) {\n        # Change 'error' to whatever keyword you are looking for\n        if ($line =~ /error|warning|fail/i) {\n            print "L$.: $line";\n        }\n    }\n    close($fh);\n} else {\n    print "Please upload a CSV file first.";\n}`,

            pl_transform: `# Perl Data Transformation: Manipulate CSV columns\nuse strict;\nuse warnings;\n\nmy $file = 'uploaded_data.csv';\n\nif (-e $file) {\n    open(my $in, '<', $file) or die $!;\n    open(my $out, '>', 'transformed.csv') or die $!;\n    \n    while (<$in>) {\n        chomp;\n        my @fields = split(/,/, $_);\n        \n        # EXAMPLE: Uppercase the first column and add a timestamp column\n        $fields[0] = uc($fields[0]);\n        push @fields, time();\n        \n        my $new_line = join(",", @fields);\n        print $out "$new_line\\n";\n        print "$new_line\\n" if $. <= 10; # Print first 10 rows to UI\n    }\n    \n    close($in);\n    close($out);\n    \n    # Overwrite the main file so it can be downloaded\n    rename('transformed.csv', $file);\n    print "--- SUCCESS ---\\nProcessed $. lines. Data overwritten in virtual FS.";\n} else {\n    print "No file found.";\n}`
        };

        // --- Initialization ---

        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: recipes.py_basic,
                language: 'python',
                theme: 'vs-dark',
                automaticLayout: true,
                fontSize: 14,
                minimap: { enabled: false }
            });
            initEngines();
        });

        async function initEngines() {
            const status = document.getElementById('status');
            try {
                pyodide = await loadPyodide();
                await pyodide.loadPackage(['pandas', 'matplotlib']);
                
                status.innerText = "Python Ready | Perl Ready";
                document.getElementById('runBtn').disabled = false;
                
                if (uploadedFileData) {
                    syncFilesToWASM(uploadedFileData);
                }
            } catch (e) {
                status.innerText = "Engine Init Error";
                console.error("Pyodide Init Error:", e);
                document.getElementById('output-area').innerText = "FATAL ERROR: Failed to load Pyodide. Please refresh.";
            }
        }

        // --- File Handling ---

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const text = await file.text();
            uploadedFileData = text;
            document.getElementById('file-indicator').innerText = `Loaded: ${file.name}`;
            document.getElementById('downloadBtn').classList.remove('hidden');
            
            syncFilesToWASM(text);
            log(`File "${file.name}" sync'd to virtual filesystems.`);
        });

        function syncFilesToWASM(text) {
            if (pyodide && pyodide.FS) {
                pyodide.FS.writeFile('uploaded_data.csv', text);
            }
            if (window.Perl && window.Perl.FS) {
                window.Perl.FS.writeFile('uploaded_data.csv', text);
            }
        }

        async function downloadData() {
            let data = "";
            try {
                if (currentLang === 'python') {
                    data = pyodide.FS.readFile('uploaded_data.csv', { encoding: 'utf8' });
                } else {
                    data = Perl.FS.readFile('uploaded_data.csv', { encoding: 'utf8' });
                }
                
                const blob = new Blob([data], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'chainsaw_processed_data.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (err) {
                alert("Error reading file from virtual filesystem: " + err.message);
            }
        }

        // --- Execution Logic ---

        async function runScript() {
            const code = editor.getValue();
            const output = document.getElementById('output-area');
            const viz = document.getElementById('viz-container');
            const chartImg = document.getElementById('py-chart');
            
            output.innerText = "Executing...\n";
            viz.classList.add('hidden');

            try {
                if (currentLang === 'python') {
                    pyodide.runPython(`
                        import sys
                        import io
                        sys.stdout = io.StringIO()
                    `);
                    
                    await pyodide.runPythonAsync(code);
                    
                    let stdout = pyodide.runPython("sys.stdout.getvalue()");
                    
                    if (stdout.includes("##CHART##")) {
                        const parts = stdout.split("##CHART##");
                        stdout = parts[0];
                        chartImg.src = `data:image/png;base64,${parts[1].trim()}`;
                        viz.classList.remove('hidden');
                    }
                    
                    output.innerText = stdout || "Script executed (no output).";
                } else {
                    if (!window.Perl) {
                        output.innerText = "Perl engine not fully loaded yet.";
                        return;
                    }

                    Perl.FS.writeFile('/tmp/output.txt', '');
                    
                    Perl.eval(`
                        open(my $out_fh, '>', '/tmp/output.txt');
                        select $out_fh;
                        ${code}
                        select STDOUT;
                        close $out_fh;
                    `);
                    
                    const result = Perl.FS.readFile('/tmp/output.txt', { encoding: 'utf8' });
                    output.innerText = result || "Script executed.";
                }
            } catch (err) {
                output.innerText = `RUNTIME ERROR:\n${err.message}`;
            }
        }

        // --- UI Helpers ---

        function switchLang(lang) {
            currentLang = lang;
            document.getElementById('btn-python').className = lang === 'python' ? 'px-4 py-2 md:px-6 md:py-3 font-medium transition-all tab-active text-xs md:text-sm custom-focus' : 'px-4 py-2 md:px-6 md:py-3 font-medium transition-all text-xs md:text-sm custom-focus';
            document.getElementById('btn-perl').className = lang === 'perl' ? 'px-4 py-2 md:px-6 md:py-3 font-medium transition-all tab-active text-xs md:text-sm custom-focus' : 'px-4 py-2 md:px-6 md:py-3 font-medium transition-all text-xs md:text-sm custom-focus';
            
            document.getElementById('recipes-python').classList.toggle('hidden', lang !== 'python');
            document.getElementById('recipes-perl').classList.toggle('hidden', lang !== 'perl');

            const model = editor.getModel();
            monaco.editor.setModelLanguage(model, lang);
            
            if (lang === 'python') {
                editor.setValue(recipes.py_basic);
            } else {
                editor.setValue(recipes.pl_grep);
            }
        }

        function loadRecipe(key) {
            if (recipes[key]) {
                editor.setValue(recipes[key]);
            }
        }

        function log(msg) {
            const output = document.getElementById('output-area');
            output.innerText += `\n[SYSTEM] ${msg}`;
        }

    </script>
</body>
</html>
